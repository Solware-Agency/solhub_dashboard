# üìö Contexto del Proyecto SolHub

Este documento contiene informaci√≥n importante sobre el ecosistema SolHub para referencia en futuras conversaciones.

## üéØ ¬øQu√© es SolHub?

**SolHub** es una plataforma SaaS multi-tenant dise√±ada para la gesti√≥n integral de laboratorios cl√≠nicos. El sistema permite que m√∫ltiples laboratorios compartan la misma infraestructura mientras mantienen un aislamiento total de datos mediante arquitectura multi-tenant con Row-Level Security (RLS).

### Caracter√≠sticas Principales
- **Multi-tenancy completo:** Cada laboratorio tiene su propio espacio aislado de datos
- **Branding personalizado:** Logo, colores y nombre por laboratorio
- **Feature flags:** Funcionalidades habilitadas/deshabilitadas por laboratorio
- **Configuraci√≥n granular:** Campos, acciones y m√≥dulos personalizables por laboratorio
- **Gesti√≥n de casos m√©dicos:** Registro, seguimiento y aprobaci√≥n de casos
- **Sistema de roles:** Owner, employee, residente, citotecno, patologo, etc.
- **Auditor√≠a completa:** Historial de cambios y logs de todas las operaciones

### Rol del Asistente

Como asistente de desarrollo para SolHub, tu rol es:

1. **Desarrollador Full-Stack Especializado:**
   - Conoces profundamente la arquitectura multi-tenant de SolHub
   - Entiendes c√≥mo funciona Supabase (Forms conspat) con RLS, triggers y funciones
   - Dominas React, TypeScript, Next.js y las tecnolog√≠as del stack

2. **Experto en Multi-Tenancy:**
   - SIEMPRE consideras `laboratory_id` en todas las operaciones
   - NUNCA haces queries sin filtrar por `laboratory_id`
   - Validas RLS policies en todas las tablas nuevas
   - Entiendes el aislamiento de datos entre laboratorios

3. **Gu√≠a de Arquitectura:**
   - Proporcionas contexto sobre la estructura del proyecto
   - Ayudas a navegar entre componentes, servicios y funcionalidades
   - Conoces la ubicaci√≥n de archivos importantes en ambos repositorios

4. **Consultor de Base de Datos:**
   - Conoces todas las tablas, funciones, triggers y pol√≠ticas RLS
   - Ayudas con migraciones y cambios en la estructura
   - Entiendes el sistema de c√≥digos flexibles y configuraci√≥n de m√≥dulos

5. **Mantenedor de Consistencia:**
   - Aseguras que el c√≥digo siga los patrones establecidos
   - Verificas que las nuevas features respeten multi-tenancy
   - Validas que los cambios no rompan el aislamiento de datos

**IMPORTANTE:** Este archivo sirve como tu "directorio de referencia" para tener siempre a mano la estructura completa del proyecto, componentes, servicios, assets y funcionalidades de SolHub.

## üîß Configuraci√≥n MCP (Model Context Protocol)

### Supabase MCP
- **Proyecto principal:** Forms conspat (SolHub)
- **Project ID:** `sbqepjsxnqtldyvlntqk`
- **URL:** `https://sbqepjsxnqtldyvlntqk.supabase.co`
- **Estado:** ACTIVE_HEALTHY
- **PostgreSQL:** 17.4.1
- **Token configurado en:** `C:\Users\andre\.cursor\mcp.json`

### GitHub MCP
- **Token configurado:** ‚úÖ
- **Organizaci√≥n:** Solware-Agency
- **Repositorios accesibles:** Todos los repos de Solware-Agency

## üìÅ Estructura de Directorios y Archivos

### Solhub_prod (Aplicaci√≥n Principal)

```
Solhub_prod/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ features/              # Funcionalidades organizadas por dominio
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/              # Autenticaci√≥n y registro
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/    # RegisterForm, LoginForm, etc.
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/      # Servicios de autenticaci√≥n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cases/             # Gesti√≥n de casos m√©dicos
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/    # Formularios de registro, listas, detalles
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/      # Servicios de casos (Supabase)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ patients/          # Gesti√≥n de pacientes
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/    # Formularios, listas, b√∫squeda
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/      # Servicios de pacientes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ triage/            # Registros de triaje m√©dico
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ changelog/         # Historial de cambios
‚îÇ   ‚îú‚îÄ‚îÄ shared/                # C√≥digo compartido
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/        # Componentes reutilizables (UI)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/             # Hooks personalizados
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useLaboratory.ts      # Hook para laboratorio actual
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ useModuleConfig.ts    # Hook para configuraci√≥n de m√≥dulos
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ useModuleField.ts     # Hook para campos de m√≥dulos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/          # Servicios compartidos
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ supabase/      # Cliente Supabase y servicios
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ cases/     # Servicios de casos m√©dicos
‚îÇ   ‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ patients/   # Servicios de pacientes
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ laboratory-codes/  # Servicios de c√≥digos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/             # Tipos TypeScript compartidos
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.ts       # Interfaces principales
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/             # Utilidades
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ contexts/          # Contextos React
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ LaboratoryContext.tsx  # Contexto del laboratorio
‚îÇ   ‚îú‚îÄ‚îÄ assets/                # Recursos est√°ticos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ images/            # Im√°genes
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ icons/             # √çconos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ fonts/             # Fuentes
‚îÇ   ‚îú‚îÄ‚îÄ styles/                # Estilos globales
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ globals.css        # CSS global con variables del laboratorio
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx                # Componente ra√≠z
‚îÇ   ‚îî‚îÄ‚îÄ main.tsx               # Punto de entrada
‚îú‚îÄ‚îÄ supabase/
‚îÇ   ‚îî‚îÄ‚îÄ migrations/            # Migraciones SQL (115 migraciones)
‚îÇ       ‚îî‚îÄ‚îÄ README_MULTITENANT_MIGRATION.md
‚îú‚îÄ‚îÄ public/                     # Archivos p√∫blicos
‚îú‚îÄ‚îÄ .cursorrules               # Contexto completo (142KB)
‚îî‚îÄ‚îÄ package.json               # Dependencias (pnpm)
```

**Componentes Clave:**
- `src/features/cases/components/MedicalFormContainer.tsx` - Formulario principal de casos
- `src/shared/contexts/LaboratoryContext.tsx` - Contexto del laboratorio actual
- `src/shared/components/FeatureGuard.tsx` - Componente para feature flags
- `src/features/auth/components/RegisterForm.tsx` - Formulario de registro (pendiente: c√≥digos)

**Servicios Clave:**
- `src/shared/services/supabase/cases/registration-service.ts` - Servicio de registro de casos
- `src/shared/services/supabase/cases/registration-helpers.ts` - Helpers de registro
- `src/shared/services/supabase/patients/patients-service.ts` - Servicio de pacientes

### solhub_dashboard (Dashboard Administrativo)

```
solhub_dashboard/
‚îú‚îÄ‚îÄ app/                       # Next.js App Router
‚îÇ   ‚îî‚îÄ‚îÄ (dashboard)/           # Rutas del dashboard
‚îÇ       ‚îú‚îÄ‚îÄ laboratories/       # Gesti√≥n de laboratorios
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ [id]/          # Edici√≥n de laboratorio
‚îÇ       ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ edit/      # P√°gina de edici√≥n completa
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ new/           # Crear nuevo laboratorio
‚îÇ       ‚îú‚îÄ‚îÄ features/          # Gesti√≥n de features
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ catalog/       # Cat√°logo de features
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ assign/        # Asignaci√≥n a laboratorios
‚îÇ       ‚îú‚îÄ‚îÄ modules/           # Configuraci√≥n de m√≥dulos
‚îÇ       ‚îú‚îÄ‚îÄ codes/             # Gesti√≥n de c√≥digos de acceso
‚îÇ       ‚îî‚îÄ‚îÄ users/             # Vista global de usuarios (30%)
‚îú‚îÄ‚îÄ components/                # Componentes del dashboard
‚îÇ   ‚îú‚îÄ‚îÄ laboratories/          # Componentes de laboratorios
‚îÇ   ‚îú‚îÄ‚îÄ features/             # Componentes de features
‚îÇ   ‚îî‚îÄ‚îÄ modules/              # Componentes de m√≥dulos
‚îú‚îÄ‚îÄ lib/                       # Utilidades y helpers
‚îÇ   ‚îú‚îÄ‚îÄ supabase/             # Cliente Supabase
‚îÇ   ‚îî‚îÄ‚îÄ types/                # Tipos TypeScript
‚îú‚îÄ‚îÄ supabase/                  # Configuraci√≥n Supabase
‚îÇ   ‚îî‚îÄ‚îÄ types/                # Tipos generados autom√°ticamente
‚îú‚îÄ‚îÄ .cursorrules              # Contexto completo (141KB)
‚îî‚îÄ‚îÄ package.json              # Dependencias (pnpm)
```

**P√°ginas Clave:**
- `app/(dashboard)/laboratories/[id]/edit/page.tsx` - Edici√≥n completa de laboratorio (m√≥dulos, features, branding)
- `app/(dashboard)/features/catalog/page.tsx` - Cat√°logo de features
- `app/(dashboard)/codes/page.tsx` - Gesti√≥n de c√≥digos de acceso

### Assets y Recursos

**Im√°genes y Logos:**
- Logos de laboratorios: Almacenados en Supabase Storage o URLs externas
- √çconos: Sistema de √≠conos (probablemente Lucide React o similar)
- Branding: Configurado en `laboratories.branding` (JSONB)

**Estilos:**
- CSS Variables globales: Definidas en `src/styles/globals.css`
- Variables del laboratorio: Inyectadas din√°micamente desde `laboratories.branding`
- TailwindCSS: Configuraci√≥n en `tailwind.config.js`

**Tipos TypeScript:**
- Generados autom√°ticamente desde Supabase
- Ubicaci√≥n: `supabase/types/` (dashboard) y `src/shared/types/` (prod)
- Actualizaci√≥n: Comando de generaci√≥n en dashboard

## üì¶ Repositorios de SolHub

### 1. **Solhub_prod** (Repositorio Principal)
- **URL:** `https://github.com/Solware-Agency/Solhub_prod`
- **Prop√≥sito:** Aplicaci√≥n principal SaaS multi-tenant para laboratorios cl√≠nicos
- **Branch principal:** `main`
- **Estado:** ‚úÖ **100% MULTI-TENANT COMPLETADO - LISTO PARA PRODUCCI√ìN**
- **Stack Tecnol√≥gico:**
  - Frontend: React 18.2.0 + TypeScript + Vite 6.3.5
  - UI: TailwindCSS 4.1.12 + Radix UI + shadcn/ui
  - Estado: TanStack Query + React Hook Form + Zod
  - Backend: Supabase (PostgreSQL con RLS) + Express
  - Hosting: Vercel (Frontend + Serverless Functions)
- **Arquitectura:** Multi-tenancy con Row-Level Security (RLS)
- **Caracter√≠sticas:**
  - ‚úÖ Sistema 100% multi-tenant funcionando
  - ‚úÖ Aislamiento total de datos por laboratorio
  - ‚úÖ Branding din√°mico (logo, colores, nombre)
  - ‚úÖ Feature flags por laboratorio
  - ‚úÖ CSS Variables globales del laboratorio
  - ‚úÖ 2 laboratorios activos: Conspat (23 usuarios) y Solhub Demo (1 usuario)

### 2. **solhub_dashboard** (Dashboard Administrativo)
- **URL:** `https://github.com/Solware-Agency/solhub_dashboard`
- **Prop√≥sito:** Panel de control administrativo para gestionar el SaaS
- **Estado:** ‚úÖ **95% COMPLETADO - LISTO PARA PRODUCCI√ìN**
- **Tecnolog√≠a:** Next.js 15 + TypeScript + Supabase
- **Autenticaci√≥n:** Sin autenticaci√≥n (acceso directo para desarrollo)
- **Funcionalidades Implementadas (100%):**
  - ‚úÖ CRUD completo de laboratorios
  - ‚úÖ Gesti√≥n completa de features (cat√°logo + asignaci√≥n)
  - ‚úÖ Sistema de Configuraci√≥n Granular de M√≥dulos ‚≠ê
  - ‚úÖ Generador autom√°tico de tipos TypeScript (CR√çTICO)
  - ‚úÖ Gesti√≥n completa de c√≥digos de acceso ‚≠ê
- **Funcionalidades Parciales:**
  - ‚ö†Ô∏è Vista global de usuarios (30% - lista b√°sica)

### 3. **Solhub_web** (Sitio Web Promocional)
- **URL:** `https://github.com/Solware-Agency/Solhub_web`
- **Prop√≥sito:** Sitio web promocional/landing page para marketing
- **No es la aplicaci√≥n:** Es solo el sitio web de promoci√≥n

### 4. **Solhub_demo**
- **URL:** `https://github.com/Solware-Agency/Solhub_demo`
- **Prop√≥sito:** Versi√≥n demo de la aplicaci√≥n

### 5. **Manual_solhub_conspat**
- **URL:** `https://github.com/Solware-Agency/Manual_solhub_conspat`
- **Prop√≥sito:** Manual y documentaci√≥n del proyecto

## üóÑÔ∏è Base de Datos Supabase

### Proyecto: Forms conspat
- **Project ID:** `sbqepjsxnqtldyvlntqk`
- **Regi√≥n:** us-east-1
- **Creado:** 17 de junio de 2025
- **PostgreSQL:** 17.4.1
- **Migraciones:** 115 migraciones aplicadas

### Tablas Principales (Estructura Completa)

#### 1. **`patients`** - Pacientes/asegurados
- **Registros:** 32 (en base de datos actual)
- **Multi-tenant:** ‚úÖ `laboratory_id` (obligatorio, NOT NULL)
- **Campos completos:**
  - `id` (uuid, PK, default: gen_random_uuid())
  - `cedula` (varchar, nullable) - N√∫mero de c√©dula √∫nico del paciente
  - `nombre` (varchar, NOT NULL) - Nombre del paciente
  - `edad` (text, nullable)
  - `telefono` (varchar, nullable)
  - `email` (varchar, nullable)
  - `gender` (enum: 'Masculino', 'Femenino', nullable)
  - `version` (integer, default: 1) - Control de cambios optimista
  - `created_at` (timestamptz, default: now())
  - `updated_at` (timestamptz, default: now())
  - `laboratory_id` (uuid, NOT NULL, FK ‚Üí laboratories.id)
- **Constraints:**
  - UNIQUE `(cedula, laboratory_id)` - Permite duplicados entre labs
  - FK: `patients_laboratory_id_fkey` ‚Üí `laboratories.id`
- **√çndices:**
  - `idx_patients_laboratory` (laboratory_id)
  - `idx_patients_cedula` (cedula)
  - `idx_patients_cedula_lower` (lower(cedula))
  - `idx_patients_nombre_lower` (lower(nombre))
  - `idx_patients_lab_created` (laboratory_id, created_at DESC)
  - `unique_cedula_per_laboratory` (cedula, laboratory_id) WHERE cedula IS NOT NULL

#### 2. **`medical_records_clean`** - Registros m√©dicos/casos
- **Registros:** 34 (en base de datos actual)
- **Multi-tenant:** ‚úÖ `laboratory_id` (obligatorio, NOT NULL)
- **Campos principales:**
  - `id` (uuid, PK)
  - `exam_type` (text, nullable) - Tipo de examen
  - `origin` (text, NOT NULL) - Origen del caso
  - `treating_doctor` (text, NOT NULL) - M√©dico tratante
  - `sample_type` (text, NOT NULL) - Tipo de muestra
  - `number_of_samples` (integer, NOT NULL, check: > 0)
  - `relationship` (text, nullable)
  - `branch` (text, nullable) - Sucursal
  - `date` (timestamptz, NOT NULL) - Fecha del caso
  - `consulta` (text, nullable) - Especialidad m√©dica (solo SPT)
- **Pagos (4 m√©todos):**
  - `payment_method_1` a `payment_method_4` (text, nullable)
  - `payment_amount_1` a `payment_amount_4` (numeric, nullable)
  - `payment_reference_1` a `payment_reference_4` (text, nullable)
  - `total_amount` (numeric, nullable, check: > 0) - Monto total en USD
  - `exchange_rate` (numeric, nullable) - Tasa de cambio USD/VES
  - `payment_status` (enum: 'Incompleto', 'Pagado', default: 'Incompleto')
  - `remaining` (numeric, nullable, default: 0) - Monto restante por pagar
- **Documentos y URLs:**
  - `attachment_url` (text, nullable) - URL de archivo adjunto
  - `googledocs_url` (text, nullable) - URL del informe editable
  - `informepdf_url` (text, nullable) - Informe completo en PDF
  - `informe_qr` (text, nullable) - Informe con QR
  - `token` (text, nullable) - Token de verificaci√≥n para informes
  - `pdf_en_ready` (boolean, default: false) - PDF listo
- **Aprobaci√≥n:**
  - `doc_aprobado` (enum: 'faltante', 'pendiente', 'aprobado', 'rechazado', default: 'faltante')
  - `cito_status` (enum: 'positivo', 'negativo', nullable) - Estado citol√≥gico
  - `email_sent` (boolean, default: false)
- **C√≥digo y tracking:**
  - `code` (text, nullable) - C√≥digo √∫nico del caso
  - `ims` (text, nullable)
- **Auditor√≠a:**
  - `created_by` (uuid, nullable, FK ‚Üí auth.users.id)
  - `created_by_display_name` (text, nullable)
  - `generated_by` (uuid, nullable, FK ‚Üí auth.users.id)
  - `generated_by_display_name` (text, nullable)
  - `generated_at` (timestamptz, nullable)
  - `created_at` (timestamptz, default: now())
  - `updated_at` (timestamptz, default: now())
- **Relaciones:**
  - `patient_id` (uuid, nullable, FK ‚Üí patients.id)
  - `laboratory_id` (uuid, NOT NULL, FK ‚Üí laboratories.id)
- **Constraints:**
  - UNIQUE `(code, laboratory_id)` - C√≥digo √∫nico por laboratorio
  - FK: `medical_records_clean_patient_id_fkey` ‚Üí `patients.id`
  - FK: `medical_records_clean_laboratory_id_fkey` ‚Üí `laboratories.id`
- **√çndices principales:**
  - `idx_medical_records_laboratory` (laboratory_id)
  - `idx_medical_records_code` (code) WHERE code IS NOT NULL
  - `idx_medical_records_patient_id` (patient_id)
  - `idx_medical_records_created_at` (created_at DESC)
  - `idx_medical_records_lab_created` (laboratory_id, created_at DESC)
  - `idx_medical_records_payment_status` (payment_status)
  - `idx_medical_records_exam_type` (exam_type)
  - `idx_medical_records_branch` (branch)
  - `medical_records_clean_code_laboratory_unique` (code, laboratory_id) UNIQUE

#### 3. **`laboratories`** - Cat√°logo de laboratorios
- **Registros:** 0 (en base de datos actual, pero 2 activos seg√∫n contexto)
- **Campos:**
  - `id` (uuid, PK, default: gen_random_uuid())
  - `slug` (text, NOT NULL, UNIQUE) - Identificador √∫nico (ej: conspat, labvargas)
  - `name` (text, NOT NULL) - Nombre del laboratorio
  - `status` (text, default: 'active', check: 'active'|'inactive'|'trial')
  - `features` (jsonb, default: {...}) - Configuraci√≥n de features habilitadas
  - `branding` (jsonb, default: {...}) - Logo, colores, √≠conos
  - `config` (jsonb, default: {...}) - Configuraci√≥n espec√≠fica:
    - `branches` - Array de sucursales
    - `timezone` - Zona horaria
    - `paymentMethods` - M√©todos de pago
    - `requiresApproval` - Requiere aprobaci√≥n de usuarios
    - `defaultExchangeRate` - Tasa de cambio por defecto
    - `allowsDigitalSignature` - Permite firma digital
    - `autoSendEmailsOnApproval` - Enviar emails autom√°ticamente
    - `modules` - Configuraci√≥n granular de m√≥dulos
    - `codeTemplate` - Plantilla de c√≥digos (sistema flexible)
    - `codeMappings` - Mapeos de c√≥digos de examen
  - `available_roles` (text[], default: ['employee']) - Roles disponibles
  - `created_at` (timestamptz, default: now())
  - `updated_at` (timestamptz, default: now())
- **√çndices:**
  - `idx_laboratories_slug` (slug)
  - `idx_laboratories_status` (status)
  - `laboratories_slug_key` (slug) UNIQUE

#### 4. **`profiles`** - Perfiles de usuarios
- **Registros:** 0 (en base de datos actual, pero 23 usuarios seg√∫n contexto)
- **Multi-tenant:** ‚úÖ `laboratory_id` (obligatorio, NOT NULL)
- **Campos:**
  - `id` (uuid, PK, FK ‚Üí auth.users.id)
  - `email` (text, NOT NULL, UNIQUE)
  - `email_lower` (text, nullable, UNIQUE) - Email en min√∫sculas
  - `role` (text, NOT NULL, default: 'employee', check: owner|employee|residente|citotecno|patologo|medicowner|medico_tratante|enfermero)
  - `estado` (text, NOT NULL, default: 'pendiente', check: 'pendiente'|'aprobado')
  - `display_name` (text, nullable) - Nombre para mostrar en UI
  - `phone` (text, nullable) - Tel√©fono
  - `assigned_branch` (text, nullable) - Sucursal asignada (filtrado de acceso)
  - `laboratory_id` (uuid, NOT NULL, FK ‚Üí laboratories.id)
  - `created_at` (timestamptz, default: now())
  - `updated_at` (timestamptz, default: now())
- **Constraints:**
  - FK: `profiles_id_fkey` ‚Üí `auth.users.id`
  - FK: `profiles_laboratory_id_fkey` ‚Üí `laboratories.id`
- **√çndices:**
  - `idx_profiles_laboratory` (laboratory_id)
  - `idx_profiles_email` (email)
  - `idx_profiles_role` (role)
  - `idx_profiles_estado` (estado)
  - `idx_profiles_lab_role` (laboratory_id, role)
  - `profiles_email_key` (email) UNIQUE
  - `profiles_email_lower_uq` (email_lower) UNIQUE

#### 5. **`triaje_records`** - Registros de triaje m√©dico
- **Registros:** 2
- **Multi-tenant:** ‚úÖ `laboratory_id` (obligatorio, NOT NULL)
- **Campos principales:**
  - `id` (uuid, PK)
  - `patient_id` (uuid, NOT NULL, FK ‚Üí patients.id)
  - `case_id` (uuid, nullable, FK ‚Üí medical_records_clean.id) - Un caso puede tener m√°ximo un triaje
  - `laboratory_id` (uuid, NOT NULL, FK ‚Üí laboratories.id)
  - `measurement_date` (timestamptz, NOT NULL, default: now()) - Fecha de medici√≥n
- **Mediciones f√≠sicas:**
  - `height_cm` (numeric, nullable, check: 30-250) - Altura en cm
  - `weight_kg` (numeric, nullable, check: 1-300) - Peso en kg
  - `bmi` (numeric, nullable, check: 10-60) - √çndice de Masa Corporal (calculado autom√°ticamente)
  - `blood_pressure` (integer, nullable) - Presi√≥n arterial (mmHg)
  - `heart_rate` (integer, nullable, check: 30-250) - Frecuencia card√≠aca
  - `respiratory_rate` (integer, nullable, check: 5-60) - Frecuencia respiratoria
  - `oxygen_saturation` (integer, nullable, check: 0-100) - Saturaci√≥n de ox√≠geno
  - `temperature_celsius` (numeric, nullable, check: 30-45) - Temperatura
- **H√°bitos:**
  - `alcohol` (enum: 'muy alta'|'alta'|'media'|'baja'|'muy baja'|'No', nullable)
  - `tabaco` (numeric, nullable, check: >= 0) - √çndice tab√°quico (paquetes-a√±o)
  - `cafe` (integer, nullable, check: >= 0) - Tazas de caf√© por d√≠a
- **Historial m√©dico:**
  - `reason` (text, nullable) - Motivo de consulta
  - `personal_background` (text, nullable) - Antecedentes personales
  - `family_history` (text, nullable) - Antecedentes familiares
  - `psychobiological_habits` (text, nullable) - H√°bitos psicobiol√≥gicos
  - `examen_fisico` (text, nullable) - Examen f√≠sico
  - `comment` (text, nullable) - Comentario
- **Auditor√≠a:**
  - `created_by` (uuid, nullable, FK ‚Üí auth.users.id)
  - `created_at` (timestamptz, default: now())
  - `updated_at` (timestamptz, default: now())
- **Constraints:**
  - UNIQUE `(case_id)` WHERE case_id IS NOT NULL - Un caso m√°ximo un triaje
  - FK: `triage_records_patient_id_fkey` ‚Üí `patients.id`
  - FK: `triage_records_case_id_fkey` ‚Üí `medical_records_clean.id`
  - FK: `triage_records_laboratory_id_fkey` ‚Üí `laboratories.id`
- **√çndices:**
  - `idx_triage_records_laboratory_id` (laboratory_id)
  - `idx_triage_records_patient_id` (patient_id)
  - `idx_triage_records_case_id` (case_id)
  - `idx_triage_records_measurement_date` (measurement_date DESC)
  - `idx_triage_records_patient_date` (patient_id, measurement_date DESC)

#### 6. **`change_logs`** - Historial de cambios (Auditor√≠a)
- **Registros:** 63 (en base de datos actual)
- **Multi-tenant:** ‚úÖ `laboratory_id` (obligatorio, NOT NULL)
- **Campos:**
  - `id` (uuid, PK, default: gen_random_uuid())
  - `medical_record_id` (uuid, nullable, FK ‚Üí medical_records_clean.id)
  - `patient_id` (uuid, nullable, FK ‚Üí patients.id)
  - `user_id` (uuid, NOT NULL, FK ‚Üí auth.users.id)
  - `user_email` (text, NOT NULL)
  - `user_display_name` (text, nullable)
  - `field_name` (text, NOT NULL) - Nombre del campo modificado
  - `field_label` (text, NOT NULL) - Etiqueta del campo
  - `old_value` (text, nullable) - Valor anterior
  - `new_value` (text, nullable) - Valor nuevo
  - `entity_type` (varchar, default: 'medical_case') - Tipo de entidad
  - `deleted_record_info` (text, nullable) - Info de registro eliminado
  - `changed_at` (timestamptz, NOT NULL, default: now())
  - `created_at` (timestamptz, default: now())
  - `laboratory_id` (uuid, NOT NULL, FK ‚Üí laboratories.id)
- **√çndices:**
  - `idx_change_logs_laboratory` (laboratory_id)
  - `idx_change_logs_medical_record_id` (medical_record_id)
  - `idx_change_logs_patient_id` (patient_id)
  - `idx_change_logs_user_id` (user_id)
  - `idx_change_logs_changed_at` (changed_at DESC)
  - `idx_change_logs_entity_type` (entity_type)

#### 7. **`feature_catalog`** - Cat√°logo maestro de features
- **Registros:** 0 (en base de datos actual, pero 8 features seg√∫n contexto)
- **RLS:** ‚ùå Deshabilitado (lectura p√∫blica)
- **Campos:**
  - `id` (uuid, PK, default: gen_random_uuid())
  - `key` (text, NOT NULL, UNIQUE) - Identificador √∫nico (ej: hasForm, hasChatAI)
  - `name` (text, NOT NULL) - Nombre descriptivo para UI
  - `description` (text, nullable)
  - `category` (text, nullable, check: 'core'|'premium'|'addon')
  - `required_plan` (text, nullable, check: 'free'|'basic'|'pro'|'enterprise')
  - `icon` (text, nullable) - √çcono para UI
  - `is_active` (boolean, default: true) - Feature activa en cat√°logo
  - `default_value` (boolean, default: false) - Valor por defecto para nuevos labs
  - `component_path` (text, nullable) - Ruta del componente
  - `created_at` (timestamptz, default: now())
  - `updated_at` (timestamptz, default: now())
- **Features conocidas:**
  - `hasInmunoRequests` - Solicitudes de inmunohistoqu√≠mica
  - `hasChangelogModule` - M√≥dulo de historial de cambios
  - `hasChatAI` - Chat con IA
  - `hasRobotTracking` - Seguimiento de robots
  - `hasCitologyStatus` - Estado citol√≥gico
  - `hasMultipleBranches` - M√∫ltiples sucursales
  - `hasPatientOriginFilter` - Filtro de origen de pacientes
- **√çndices:**
  - `idx_feature_catalog_key` (key)
  - `idx_feature_catalog_active` (is_active) WHERE is_active = true
  - `feature_catalog_key_key` (key) UNIQUE

#### 8. **`module_catalog`** - Cat√°logo de m√≥dulos
- **Registros:** 0 (en base de datos actual, pero 1 m√≥dulo seg√∫n contexto: registrationForm)
- **RLS:** ‚úÖ Habilitado (lectura p√∫blica)
- **Campos:**
  - `id` (uuid, PK, default: gen_random_uuid())
  - `feature_key` (text, NOT NULL, UNIQUE, FK ‚Üí feature_catalog.key) - Key de la feature
  - `module_name` (text, NOT NULL) - Nombre usado en config.modules (ej: registrationForm)
  - `structure` (jsonb, NOT NULL) - Estructura que define campos, acciones y settings
  - `is_active` (boolean, default: true)
  - `created_at` (timestamptz, default: now())
  - `updated_at` (timestamptz, default: now())
- **Constraint:**
  - FK: `fk_module_feature` ‚Üí `feature_catalog.key`
- **√çndices:**
  - `idx_module_catalog_feature_key` (feature_key)
  - `idx_module_catalog_active` (is_active) WHERE is_active = true
  - `module_catalog_feature_key_key` (feature_key) UNIQUE

#### 9. **`laboratory_codes`** - C√≥digos de acceso
- **Registros:** 0 (tabla vac√≠a actualmente)
- **RLS:** ‚úÖ Habilitado (temporalmente deshabilitado para dashboard)
- **Campos:**
  - `id` (uuid, PK, default: gen_random_uuid())
  - `laboratory_id` (uuid, NOT NULL, FK ‚Üí laboratories.id)
  - `code` (text, NOT NULL, UNIQUE) - C√≥digo de acceso
  - `is_active` (boolean, default: true) - C√≥digo activo
  - `max_uses` (integer, nullable, check: > 0) - Usos m√°ximos (NULL = ilimitado)
  - `current_uses` (integer, nullable, default: 0, check: >= 0) - Usos actuales
  - `expires_at` (timestamptz, nullable) - Fecha de expiraci√≥n
  - `created_by` (uuid, nullable) - Usuario que cre√≥ el c√≥digo
  - `created_at` (timestamptz, default: now())
  - `updated_at` (timestamptz, default: now())
- **Constraint:**
  - FK: `laboratory_codes_laboratory_id_fkey` ‚Üí `laboratories.id`
- **√çndices:**
  - `idx_lab_codes_laboratory` (laboratory_id)
  - `idx_lab_codes_code` (code) WHERE is_active = true
  - `idx_lab_codes_active` (is_active, expires_at)
  - `laboratory_codes_code_key` (code) UNIQUE

#### 10. **`immuno_requests`** - Solicitudes de inmunohistoqu√≠mica
- **Registros:** 0
- **Multi-tenant:** ‚úÖ `laboratory_id` (obligatorio, NOT NULL)
- **Campos:**
  - `id` (uuid, PK, default: gen_random_uuid())
  - `case_id` (uuid, NOT NULL, UNIQUE, FK ‚Üí medical_records_clean.id)
  - `inmunorreacciones` (text, NOT NULL) - Lista separada por comas de inmunorreacciones
  - `n_reacciones` (integer, NOT NULL) - N√∫mero de reacciones
  - `precio_unitario` (numeric, NOT NULL, default: 18.00) - Precio por reacci√≥n
  - `total` (numeric, NOT NULL) - Total calculado (n_reacciones * precio_unitario)
  - `pagado` (boolean, NOT NULL, default: false) - Si las reacciones han sido pagadas
  - `laboratory_id` (uuid, NOT NULL, FK ‚Üí laboratories.id)
  - `created_at` (timestamptz, default: now())
  - `updated_at` (timestamptz, default: now())
- **Constraints:**
  - FK: `immuno_requests_case_id_fkey` ‚Üí `medical_records_clean.id`
  - FK: `immuno_requests_laboratory_id_fkey` ‚Üí `laboratories.id`
- **√çndices:**
  - `idx_immuno_requests_case_id` (case_id)
  - `idx_immuno_requests_laboratory` (laboratory_id)
  - `idx_immuno_requests_pagado` (pagado)
  - `idx_immuno_requests_created_at` (created_at DESC)
  - `immuno_requests_case_id_key` (case_id) UNIQUE

#### 11. **`user_settings`** - Configuraciones de usuario
- **Registros:** 0
- **Multi-tenant:** ‚úÖ `laboratory_id` (obligatorio, NOT NULL)
- **Campos:**
  - `id` (uuid, PK, FK ‚Üí auth.users.id)
  - `session_timeout` (integer, NOT NULL, default: 15) - Timeout de sesi√≥n en minutos
  - `laboratory_id` (uuid, NOT NULL, FK ‚Üí laboratories.id)
  - `created_at` (timestamptz, default: timezone('utc', now()))
  - `updated_at` (timestamptz, default: timezone('utc', now()))
- **Constraints:**
  - FK: `user_settings_id_fkey` ‚Üí `auth.users.id`
  - FK: `user_settings_laboratory_id_fkey` ‚Üí `laboratories.id`
- **√çndices:**
  - `idx_user_settings_laboratory` (laboratory_id)

#### 12. **`admin_users`** - Super administradores del dashboard
- **Registros:** 1 (georgevargas868@gmail.com)
- **Prop√≥sito:** Super administradores con acceso total al dashboard
- **Nota:** Estructura no visible en queries, pero existe seg√∫n contexto

### Caracter√≠sticas del Sistema
- ‚úÖ Arquitectura multi-tenant con `laboratory_id` en todas las tablas
- ‚úÖ RLS (Row Level Security) habilitado y funcionando sin recursi√≥n
- ‚úÖ Sistema de roles y permisos por laboratorio
- ‚úÖ Gesti√≥n de features por laboratorio (habilitar/deshabilitar)
- ‚úÖ Sistema de c√≥digos √∫nicos para casos m√©dicos (flexible por lab)
- ‚úÖ Logs de cambios y auditor√≠a completa
- ‚úÖ Sistema de m√≥dulos con configuraci√≥n granular ‚≠ê
- ‚úÖ Triggers autom√°ticos para sincronizaci√≥n de features y m√≥dulos

## üîß Funcionamiento de Supabase en SolHub

### Sistema de Migraciones
- **Total de migraciones aplicadas:** 115 migraciones
- **Ubicaci√≥n:** `supabase/migrations/` en el repositorio
- **Documentaci√≥n:** `README_MULTITENANT_MIGRATION.md` - Gu√≠a completa de migraci√≥n multi-tenant
- **Proceso:** Migraciones aplicadas en orden cronol√≥gico usando Supabase CLI

### Funciones SQL Importantes (Lista Completa)

#### Generaci√≥n de C√≥digos
1. **`generate_medical_record_code_flexible()`** ‚≠ê (Sistema Flexible)
   - **Par√°metros:** `laboratory_id_input`, `exam_type_input`, `case_date_input`
   - **Prop√≥sito:** Genera c√≥digos √∫nicos por laboratorio seg√∫n plantilla configurada
   - **Caracter√≠sticas:**
     - Soporta m√∫ltiples formatos de c√≥digo por laboratorio
     - Plantillas con placeholders: `{examCode}`, `{counter:N}`, `{month}`, `{year:2}`, `{year:4}`
     - Verificaci√≥n de unicidad con `UNIQUE (code, laboratory_id)`
     - Usa `pg_advisory_xact_lock` para evitar condiciones de carrera
     - Sistema basado en `laboratories.config.codeTemplate` y `codeMappings`
     - Hasta 10 intentos para generar c√≥digo √∫nico

2. **`generate_medical_record_code_from_table()`** (Funci√≥n Legacy)
   - **Par√°metros:** `laboratory_id_input`, `exam_type_input`, `case_date_input`
   - **Prop√≥sito:** Genera c√≥digos en formato Conspat (retrocompatibilidad)
   - **Formato Conspat:** `[tipo:1d][a√±o:2d][contador:3d][mes:1letra]` (ej: `125001K`)
   - **Soporta:** Formato Conspat y formato custom (SPT)

3. **`generate_spt_custom_code()`** (Formato SPT)
   - **Par√°metros:** `exam_type_input`, `consulta_input`, `case_date_input`, `laboratory_id_input`, `laboratory_config`
   - **Prop√≥sito:** Genera c√≥digos en formato SPT personalizado
   - **Formato SPT:** `[C√ìDIGO][0001][MES][A√ëO]` (ej: `CI0001K25`)
   - **Usa:** `laboratories.config.codeFormat.typeMappings` para mapeos

4. **`get_exam_code_from_mapping()`** (Helper)
   - **Par√°metros:** `exam_type_input`, `code_mappings` (jsonb)
   - **Prop√≥sito:** Obtiene c√≥digo de examen desde mapeos JSONB
   - **B√∫squeda:** Coincidencia exacta (case-insensitive) y parcial (sin acentos)

5. **`get_exam_type_number()`** (Helper)
   - **Par√°metros:** `exam_type_input`
   - **Prop√≥sito:** Convierte tipo de examen a n√∫mero (1=citolog√≠a, 2=biopsia, 3=inmunohistoqu√≠mica)

#### Configuraci√≥n de M√≥dulos
6. **`build_module_config_from_structure()`** ‚≠ê
   - **Par√°metros:** `module_structure` (jsonb)
   - **Prop√≥sito:** Construye configuraci√≥n de m√≥dulos desde estructura base
   - **Procesa:**
     - `fields` ‚Üí `{enabled, required}` por campo
     - `actions` ‚Üí `boolean` por acci√≥n
     - `settings` ‚Üí Valores por defecto
   - **Uso:** Sincronizaci√≥n autom√°tica de nuevos campos a todos los laboratorios

7. **`apply_module_config_on_lab_insert()`** (Trigger Function)
   - **Evento:** BEFORE INSERT en `laboratories`
   - **Prop√≥sito:** Aplica autom√°ticamente configuraci√≥n de m√≥dulos al crear laboratorio
   - **L√≥gica:** Itera sobre m√≥dulos activos y aplica configuraci√≥n si la feature est√° habilitada

#### Formateo y Validaci√≥n
8. **`format_name()`** (Helper)
   - **Par√°metros:** `input_name` (text)
   - **Prop√≥sito:** Formatea nombres (capitaliza palabras, elimina espacios extra)
   - **Uso:** Formateo autom√°tico de nombres de pacientes y m√©dicos

9. **`format_patient_names()`** (Trigger Function)
   - **Evento:** BEFORE INSERT/UPDATE en `patients`
   - **Prop√≥sito:** Formatea autom√°ticamente el nombre del paciente

10. **`format_medical_record_names()`** (Trigger Function)
    - **Evento:** BEFORE INSERT/UPDATE en `medical_records_clean`
    - **Prop√≥sito:** Formatea autom√°ticamente el nombre del m√©dico tratante

11. **`enforce_doc_aprobado_transition()`** (Trigger Function) ‚≠ê
    - **Evento:** BEFORE UPDATE en `medical_records_clean.doc_aprobado`
    - **Prop√≥sito:** Enforce transiciones v√°lidas de estado de aprobaci√≥n
    - **Transiciones permitidas:**
      - Todos: `faltante` ‚Üí `pendiente`
      - Owner/Residente/Citotecno: `pendiente` ‚Üí `aprobado` o `rechazado`
      - Owner/Employee: `rechazado` ‚Üí `pendiente` (reversi√≥n)
      - Owner/Citotecno: `aprobado` ‚Üí `pendiente` o `rechazado` (reversi√≥n)

12. **`check_user_approved()`** (Trigger Function)
    - **Evento:** BEFORE INSERT/UPDATE en `auth.users`
    - **Prop√≥sito:** Verifica que el usuario est√© aprobado antes de permitir acceso
    - **Excepci√≥n:** Permite durante confirmaci√≥n inicial

#### C√°lculos Autom√°ticos
13. **`calculate_bmi()`** (Trigger Function)
    - **Evento:** BEFORE INSERT/UPDATE en `triaje_records`
    - **Prop√≥sito:** Calcula autom√°ticamente BMI desde altura y peso
    - **F√≥rmula:** `BMI = peso (kg) / (altura (m))¬≤`

14. **`actualizar_pdf_en_ready_medical()`** (Funci√≥n Manual)
    - **Prop√≥sito:** Actualiza `pdf_en_ready` basado en `informe_qr`
    - **L√≥gica:** `TRUE` si `informe_qr` tiene contenido, `FALSE` si est√° vac√≠o

15. **`actualizar_pdf_en_ready_medical_trigger()`** (Trigger Function)
    - **Evento:** BEFORE INSERT/UPDATE en `medical_records_clean`
    - **Prop√≥sito:** Actualiza autom√°ticamente `pdf_en_ready` cuando cambia `informe_qr`

#### Autenticaci√≥n y Usuarios
16. **`handle_new_user()`** ‚≠ê (Trigger Function)
    - **Evento:** AFTER INSERT en `auth.users`
    - **Prop√≥sito:** Crea perfil en `profiles` y asigna `laboratory_id` si se proporciona c√≥digo
    - **L√≥gica:**
      - Lee `laboratory_id` de `raw_user_meta_data` (OBLIGATORIO)
      - Lee `role` de metadata (fallback: 'employee')
      - Lee `phone` de metadata (m√°ximo 15 d√≠gitos)
      - Lee `display_name` de metadata (valida que no sea tel√©fono)
      - Crea perfil con estado 'pendiente' (excepto email especial)
    - **Validaciones:**
      - Verifica que el laboratorio existe
      - Valida formato de UUID para `laboratory_id`
      - Valida rol permitido

17. **`get_user_laboratory_id()`** (Helper)
    - **Prop√≥sito:** Obtiene `laboratory_id` del usuario autenticado
    - **Uso:** En RLS policies y funciones

18. **`get_user_role()`** (Helper)
    - **Prop√≥sito:** Obtiene `role` del usuario autenticado
    - **Uso:** En validaciones y RLS policies

19. **`email_exists_auth()`** (Helper)
    - **Par√°metros:** `p_email` (text)
    - **Prop√≥sito:** Verifica si un email existe en `auth.users`
    - **Uso:** Validaci√≥n de emails √∫nicos

#### Auditor√≠a y Logs
20. **`get_all_change_logs_with_deleted()`** (View Function)
    - **Prop√≥sito:** Obtiene todos los logs de cambios incluyendo registros eliminados
    - **Retorna:** Logs con informaci√≥n de caso (si existe) o info de eliminaci√≥n

#### Testing
21. **`test_multitenant_isolation()`** (Funci√≥n de Testing)
    - **Prop√≥sito:** Verifica que el aislamiento de datos funciona correctamente
    - **Tests incluidos:**
      - Verificaci√≥n de asignaci√≥n de laboratorio al usuario
      - Verificaci√≥n de aislamiento de pacientes
      - Verificaci√≥n de protecci√≥n contra inserts en otros laboratorios

### Triggers Autom√°ticos

#### 1. Generaci√≥n Autom√°tica de C√≥digos
- **Trigger:** `set_medical_record_code()`
- **Evento:** BEFORE INSERT en `medical_records_clean`
- **Funci√≥n:** Usa `generate_medical_record_code_flexible()` o funci√≥n legacy
- **Caracter√≠sticas:** Asigna c√≥digo autom√°ticamente si no se proporciona

#### 2. Asignaci√≥n de Laboratory ID
- **Trigger:** `set_laboratory_id_on_insert()`
- **Evento:** BEFORE INSERT en m√∫ltiples tablas
- **Prop√≥sito:** Asigna autom√°ticamente `laboratory_id` desde el perfil del usuario
- **Tablas afectadas:** `patients`, `medical_records_clean`, `change_logs`, etc.

#### 3. Formateo de Nombres
- **Triggers:** `format_patient_name()`, `format_medical_record_name()`
- **Evento:** BEFORE INSERT/UPDATE
- **Prop√≥sito:** Formatea nombres autom√°ticamente (may√∫sculas, espacios, etc.)

#### 4. Sincronizaci√≥n de Features
- **Trigger:** `sync_new_feature_to_laboratories`
- **Evento:** AFTER INSERT en `feature_catalog`
- **Prop√≥sito:** Agrega autom√°ticamente nuevas features a todos los laboratorios

#### 5. Sincronizaci√≥n de Campos de M√≥dulos
- **Trigger:** `sync_new_module_field`
- **Evento:** AFTER INSERT en `module_catalog`
- **Prop√≥sito:** Sincroniza nuevos campos de m√≥dulos a todos los laboratorios

#### 6. Logging de Cambios
- **Trigger:** `log_medical_record_changes`
- **Evento:** AFTER INSERT/UPDATE/DELETE en `medical_records_clean`
- **Prop√≥sito:** Registra todos los cambios en `change_logs` para auditor√≠a

#### 7. Manejo de Nuevos Usuarios
- **Trigger:** `handle_new_user()`
- **Evento:** AFTER INSERT en `auth.users`
- **Prop√≥sito:** Crea perfil en `profiles` y asigna `laboratory_id` si se proporciona c√≥digo

### Pol√≠ticas RLS (Row Level Security)

#### Patr√≥n General de RLS
Todas las pol√≠ticas RLS siguen este patr√≥n para multi-tenancy:

```sql
-- SELECT: Solo ver datos del laboratorio propio
USING (laboratory_id = (SELECT laboratory_id FROM profiles WHERE id = auth.uid()))

-- INSERT: Solo insertar en el laboratorio propio
WITH CHECK (laboratory_id = (SELECT laboratory_id FROM profiles WHERE id = auth.uid()))

-- UPDATE: Solo actualizar datos del laboratorio propio
USING (laboratory_id = ...) 
WITH CHECK (laboratory_id = ...)

-- DELETE: Solo owners/admins pueden eliminar
USING (
  laboratory_id = ... 
  AND EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role IN ('owner', 'admin'))
)
```

#### Tablas con RLS Configurado
1. **`patients`** - 4 policies (SELECT, INSERT, UPDATE, DELETE)
2. **`medical_records_clean`** - 4 policies
3. **`profiles`** - 4 policies (con restricciones especiales para owners)
4. **`change_logs`** - 2 policies (SELECT, INSERT - no UPDATE/DELETE para auditor√≠a)
5. **`immuno_requests`** - 4 policies (si existe)
6. **`user_settings`** - 3 policies (por usuario y laboratorio)
7. **`deletion_logs`** - 2 policies (solo owners pueden ver)
8. **`laboratories`** - Policies especiales para dashboard admin
9. **`feature_catalog`** - Policies para lectura p√∫blica
10. **`module_catalog`** - Policies para lectura p√∫blica

#### Caracter√≠sticas de Seguridad RLS
- ‚úÖ **Sin recursi√≥n:** Las pol√≠ticas no causan loops infinitos
- ‚úÖ **Filtrado autom√°tico:** Todos los queries se filtran por `laboratory_id`
- ‚úÖ **Protecci√≥n en m√∫ltiples niveles:** RLS + validaci√≥n en triggers + constraints
- ‚úÖ **Testing obligatorio:** Funci√≥n `test_multitenant_isolation()` para verificar

### √çndices de Performance
- **√çndices en `laboratory_id`:** Todas las tablas principales tienen √≠ndices en `laboratory_id`
- **√çndices compuestos:** Para queries comunes (ej: `(laboratory_id, code)`, `(laboratory_id, date)`)
- **√çndices de b√∫squeda:** En campos de texto frecuentemente buscados

### Sistema de C√≥digos Flexibles
- **Configuraci√≥n:** `laboratories.config.codeTemplate` (formato tipo "printf")
- **Mapeos:** `laboratories.config.codeMappings` (examen ‚Üí c√≥digo)
- **Patrones soportados:**
  - `{examCode}` - C√≥digo del examen
  - `{counter:N}` - Contador con N d√≠gitos
  - `{month}` - Letra del mes (A-L)
  - `{year:2}` - A√±o con 2 d√≠gitos desde 2000
  - `{year:4}` - A√±o completo
  - Texto literal sin `{}`

### Proceso de Migraci√≥n Multi-Tenant
**Fases completadas:**
1. ‚úÖ Crear tabla `laboratories`
2. ‚úÖ Agregar `laboratory_id` a todas las tablas
3. ‚úÖ Migrar datos existentes a Conspat
4. ‚úÖ Hacer `laboratory_id` NOT NULL
5. ‚úÖ Actualizar RLS policies para multi-tenant

**Documentaci√≥n completa:** Ver `supabase/migrations/README_MULTITENANT_MIGRATION.md`

### Extensiones de PostgreSQL Instaladas

#### Extensiones Activas (Instaladas)
1. **`plpgsql`** (v1.0) - Lenguaje procedural PL/pgSQL (requerido para funciones)
2. **`pg_graphql`** (v1.5.11) - Soporte GraphQL
3. **`supabase_vault`** (v0.3.1) - Supabase Vault Extension
4. **`pgcrypto`** (v1.3) - Funciones criptogr√°ficas
5. **`uuid-ossp`** (v1.1) - Generaci√≥n de UUIDs
6. **`pg_stat_statements`** (v1.11) - Estad√≠sticas de queries
7. **`pg_net`** (v0.14.0) - HTTP as√≠ncrono

#### Extensiones Disponibles (No Instaladas)
- **`pg_trgm`** - B√∫squeda de texto con trigramas
- **`vector`** - Tipos de datos vectoriales (AI/ML)
- **`postgis`** - Extensiones geoespaciales
- **`pg_cron`** - Programador de tareas
- **`http`** - Cliente HTTP para PostgreSQL
- **`pgmq`** - Cola de mensajes ligera
- Y muchas m√°s disponibles en Supabase

## üèóÔ∏è Arquitectura Multi-Tenant

### Patr√≥n Implementado
- **Shared Database, Shared Schema**: Todos los laboratorios usan las mismas tablas
- **Tenant Isolation**: Columna `laboratory_id` en todas las tablas principales
- **Feature Flags**: Configuraci√≥n JSON por laboratorio
- **RLS Policies**: Filtrado autom√°tico por `laboratory_id` a nivel de base de datos

### Estado de Implementaci√≥n
- ‚úÖ **FASE 1: Base de Datos** - 100% COMPLETADA
- ‚úÖ **FASE 2: Frontend** - 100% COMPLETADA
- ‚úÖ **FASE FINAL: Pre-Producci√≥n** - 100% COMPLETADA
- ‚ö†Ô∏è **FASE 3: Sistema de C√≥digos** - Pendiente (registro con c√≥digos no implementado)

### Laboratorios Activos
- **Conspat**: 23 usuarios (3 owners, 12 employees, 22 aprobados, 1 pendiente)
- **Solhub Demo**: 1 usuario (1 owner, 1 aprobado)

## üéØ Proyecto Actual: Inntegras (M√≥dulo Aseguradoras)

### Contexto
- **Cliente:** Inntegras
- **M√≥dulo:** Sistema de gesti√≥n de p√≥lizas de seguros
- **Base:** Reutiliza el core de SolHub (tabla `patients`)
- **Vertical:** Nuevo m√≥dulo dentro del SaaS multi-tenant existente

### Tablas Planificadas
1. **`patients`** - Reutilizada (asegurados) - Ya existe con `laboratory_id`
2. **`aseguradoras`** - Cat√°logo de compa√±√≠as de seguros (NUEVA)
3. **`polizas`** - N√∫cleo del negocio (NUEVA)
   - P√≥lizas, vencimientos, pagos, alertas, recordatorios
4. **`pagos_poliza`** - Hist√≥rico de pagos (NUEVA - opcional)

### Documentaci√≥n Disponible
- `Tablas Supabase.md` - Especificaci√≥n detallada de tablas
- `Formularios de registro.md` - Especificaci√≥n de formularios (wizard de 5 pasos)
- `Plan de accion - Solhub Inntegras.md` - Plan de implementaci√≥n completo

### Consideraciones Multi-Tenant
- Todas las nuevas tablas DEBEN incluir `laboratory_id`
- RLS policies deben configurarse para filtrar por `laboratory_id`
- √çndices en `laboratory_id` para performance
- Reutilizar tabla `patients` existente (ya tiene `laboratory_id`)

## üîê Configuraci√≥n de MCP

### Archivo de Configuraci√≥n
**Ubicaci√≥n:** `C:\Users\andre\.cursor\mcp.json`

### Servidores Configurados
1. **Shopify** - Configurado y activo
2. **Supabase** - Configurado y activo (token configurado en `mcp.json`)
3. **GitHub** - Configurado y activo (token configurado en `mcp.json`)

**‚ö†Ô∏è IMPORTANTE:** Los tokens de acceso est√°n configurados localmente en `C:\Users\andre\.cursor\mcp.json` y NO deben estar en el repositorio por seguridad.

## üö® Reglas Cr√≠ticas de Desarrollo

### Seguridad (NON-NEGOTIABLE)
1. **NUNCA** hacer queries sin filtrar por `laboratory_id`
2. **SIEMPRE** validar que RLS est√° habilitado en tablas nuevas
3. **SIEMPRE** verificar que el usuario pertenece al laboratorio antes de operaciones cr√≠ticas
4. **LOGUEAR** todos los accesos a datos sensibles en `change_logs`
5. **TESTEAR** exhaustivamente el aislamiento de datos entre laboratorios

### C√≥digo
1. Usar `<FeatureGuard>` para condicionar UI por features
2. Usar `useLaboratory()` hook para acceder al laboratorio actual
3. NUNCA hardcodear configuraci√≥n de laboratorios en c√≥digo
4. Mantener configuraci√≥n en tabla `laboratories` de Supabase
5. Todo servicio de Supabase DEBE incluir `.eq('laboratory_id', laboratoryId)`
6. Al insertar datos, SIEMPRE incluir `laboratory_id`

### Base de Datos
1. Toda tabla nueva DEBE tener `laboratory_id uuid references laboratories(id)`
2. Crear √≠ndice en `laboratory_id` para performance
3. Configurar RLS policies para filtrar por `laboratory_id`
4. Backups regulares con `pg_dump`

## üìã Estado Actual del Sistema

### ‚úÖ Completado (100%)
- Sistema multi-tenant completamente funcional
- Aislamiento total de datos por laboratorio
- Branding din√°mico (logo, colores, nombre, √≠conos)
- Feature flags operativos
- Dashboard administrativo al 95%
- Sistema de m√≥dulos con configuraci√≥n granular
- Generador de tipos TypeScript funcional

### ‚ö†Ô∏è Pendiente (Cr√≠tico)
- **Registro con c√≥digos en Solhub**: 0% implementado
  - Campo de c√≥digo en RegisterForm.tsx
  - Servicio de validaci√≥n de c√≥digos
  - Asignaci√≥n autom√°tica de `laboratory_id`
  - Incremento de uso del c√≥digo
  - Usuario en estado "pending approval"

### üü¢ Pendiente (Opcional)
- Completar vista global de usuarios (70% restante)
- Implementar hooks `useModuleConfig` y `useModuleField` en frontend principal
- Mejoras de UX (dise√±o pulido, gr√°ficas, animaciones)

## üìù Notas Importantes

- **Package Manager:** Usar `pnpm` por defecto
- **Idioma de respuestas:** Espa√±ol
- **Proyecto Supabase principal:** Forms conspat (`sbqepjsxnqtldyvlntqk`)
- **Repositorio principal de c√≥digo:** `Solhub_prod`
- **Dashboard administrativo:** `solhub_dashboard`
- **Archivos `.cursorrules`:** Ambos repos tienen archivos `.cursorrules` extenso 140KB+ con contexto completo

## üîó Referencias Importantes

### Archivos de Contexto en Repositorios
- **Solhub_prod**: 
  - `.cursorrules` (142KB) - Contexto completo del sistema multi-tenant
  - `.cursor/plans/` - Archivos de planificaci√≥n detallados:
    - `configuraci-n-de-m-dulos-y-campos-personalizados-ef227574.plan.md` (25KB) - Plan completo del sistema de configuraci√≥n granular de m√≥dulos y campos personalizados (‚úÖ COMPLETADO)
    - `c√≥digos_personalizados_por_laboratorio_5ff3145f.plan.md` (7KB) - Plan para sistema de c√≥digos personalizados por laboratorio (‚ö†Ô∏è PENDIENTE)
- **solhub_dashboard**: 
  - `.cursorrules` (141KB) - Contexto completo del dashboard administrativo
  - `.cursor/plans/` - Archivos de planificaci√≥n detallados:
    - `configuraci-n-de-m-dulos-y-campos-personalizados-ef227574.plan.md` (25KB) - Mismo plan que en Solhub_prod
    - `c√≥digos_personalizados_por_laboratorio_5ff3145f.plan.md` (7KB) - Mismo plan que en Solhub_prod

### Planes de Implementaci√≥n Detallados (`.cursor/plans/`)

#### 1. Configuraci√≥n de M√≥dulos y Campos Personalizados ‚úÖ COMPLETADO
- **Archivo:** `configuraci-n-de-m-dulos-y-campos-personalizados-ef227574.plan.md`
- **Estado:** ‚úÖ 100% COMPLETADO
- **Descripci√≥n:** Sistema completo de configuraci√≥n granular de m√≥dulos que permite:
  - Configurar campos personalizados por laboratorio
  - Valores por defecto para campos deshabilitados
  - Dropdowns personalizados (`examTypes`, `branches`, `paymentMethods`)
  - UI administrativa completa en dashboard
- **Fases completadas:**
  - ‚úÖ FASE 1: Valores por defecto para campos deshabilitados
  - ‚úÖ FASE 2: Administraci√≥n de dropdowns en dashboard admin
  - ‚úÖ FASE 3: Actualizaci√≥n de componentes en Solhub para usar configuraci√≥n
- **Archivos implementados:**
  - `src/shared/hooks/useModuleConfig.ts` y `useModuleField.ts`
  - `src/services/supabase/cases/registration-helpers.ts`
  - `dashboard-solhub/app/(dashboard)/laboratories/[id]/edit/page.tsx` (UI completa)

#### 2. C√≥digos Personalizados por Laboratorio ‚ö†Ô∏è PENDIENTE
- **Archivo:** `c√≥digos_personalizados_por_laboratorio_5ff3145f.plan.md`
- **Estado:** ‚ö†Ô∏è PENDIENTE (0% implementado)
- **Descripci√≥n:** Sistema flexible de generaci√≥n de c√≥digos de casos m√©dicos personalizado por laboratorio
- **Objetivo:** Permitir que cada laboratorio tenga su propio formato de c√≥digos (ej: Conspat usa `125001K`, SPT necesita `CI0001K25`)
- **Soluci√≥n propuesta:** Sistema basado en plantillas con configuraci√≥n en `laboratories.config.codeTemplate`
- **Fases planificadas:**
  - FASE 1: Base de datos y backend (funci√≥n gen√©rica en Supabase)
  - FASE 2: Dashboard admin (UI de configuraci√≥n)
- **Consideraciones:** Mantiene verificaci√≥n de unicidad con constraint `UNIQUE (code, laboratory_id)`

### Documentaci√≥n del Proyecto Inntegras
- `Tablas Supabase.md` - Especificaci√≥n de tablas para m√≥dulo de aseguradoras
- `Formularios de registro.md` - Especificaci√≥n de formularios
- `Plan de accion - Solhub Inntegras.md` - Plan de implementaci√≥n completo

---

## ‚ö†Ô∏è Nota Importante sobre Actualizaci√≥n

**Este archivo es una gu√≠a de contexto completa** que proporciona informaci√≥n detallada sobre:

- ‚úÖ **Ambos repositorios de SolHub:** `Solhub_prod` (aplicaci√≥n principal) y `solhub_dashboard` (panel administrativo)
- ‚úÖ **Base de datos Supabase completa:** Proyecto "Forms conspat" (`sbqepjsxnqtldyvlntqk`)
- ‚úÖ **Estructura completa del proyecto:** Tablas, funciones, triggers, RLS policies, √≠ndices
- ‚úÖ **Arquitectura multi-tenant:** Sistema completo de aislamiento de datos
- ‚úÖ **Funcionalidades y estado:** Qu√© est√° implementado y qu√© est√° pendiente

**‚ö†Ô∏è IMPORTANTE:** Este archivo puede no estar siempre actualizado a la versi√≥n m√°s reciente del proyecto. La informaci√≥n aqu√≠ contenida es una **excelente gu√≠a de contexto** para:

- Hacer preguntas sobre frontend, backend, Supabase, arquitectura, etc.
- Tener siempre la estructura del proyecto a la mano
- Proporcionar contexto completo en cada consulta sobre SolHub
- Entender r√°pidamente c√≥mo funciona el sistema multi-tenant
- Conocer las tablas, funciones y triggers disponibles

**Recomendaci√≥n:** Si necesitas informaci√≥n 100% actualizada sobre:
- Estado actual de implementaci√≥n de features
- N√∫mero exacto de registros en tablas
- Cambios recientes en la base de datos
- Nuevas funcionalidades agregadas

Consulta directamente:
- Los repositorios en GitHub (`Solhub_prod` y `solhub_dashboard`)
- La base de datos Supabase directamente usando MCP
- Los archivos `.cursorrules` actualizados en cada repositorio

**Este archivo sirve como punto de partida excelente** para tener todo el contexto necesario de SolHub y Supabase (Forms conspat) en cada conversaci√≥n.

---

**√öltima actualizaci√≥n:** 2025-01-26  
**Creado para:** Referencia contextual en Cursor  
**Fuentes:** 
- Archivos `.cursorrules` de Solhub_prod y solhub_dashboard
- Archivos `.cursor/plans/*.plan.md` de ambos repositorios
- Consultas directas a Supabase MCP (tablas, funciones, √≠ndices)
- Estructura completa de la base de datos "Forms conspat"
